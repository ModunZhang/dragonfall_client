<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote {
    margin: 0;
    padding: 0;
}
body {
    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    color: #737373;
    background-color: white;
    margin: 10px 13px 10px 13px;
}
table {
	margin: 10px 0 15px 0;
	border-collapse: collapse;
}
td,th {	
	border: 1px solid #ddd;
	padding: 3px 10px;
}
th {
	padding: 5px 10px;	
}

a {
    color: #0069d6;
}
a:hover {
    color: #0050a3;
    text-decoration: none;
}
a img {
    border: none;
}
p {
    margin-bottom: 9px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    color: #404040;
    line-height: 36px;
}
h1 {
    margin-bottom: 18px;
    font-size: 30px;
}
h2 {
    font-size: 24px;
}
h3 {
    font-size: 18px;
}
h4 {
    font-size: 16px;
}
h5 {
    font-size: 14px;
}
h6 {
    font-size: 13px;
}
hr {
    margin: 0 0 19px;
    border: 0;
    border-bottom: 1px solid #ccc;
}
blockquote {
    padding: 13px 13px 21px 15px;
    margin-bottom: 18px;
    font-family:georgia,serif;
    font-style: italic;
}
blockquote:before {
    content:"\201C";
    font-size:40px;
    margin-left:-10px;
    font-family:georgia,serif;
    color:#eee;
}
blockquote p {
    font-size: 14px;
    font-weight: 300;
    line-height: 18px;
    margin-bottom: 0;
    font-style: italic;
}
code, pre {
    font-family: Monaco, Andale Mono, Courier New, monospace;
}
code {
    background-color: #fee9cc;
    color: rgba(0, 0, 0, 0.75);
    padding: 1px 3px;
    font-size: 12px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}
pre {
    display: block;
    padding: 14px;
    margin: 0 0 18px;
    line-height: 16px;
    font-size: 11px;
    border: 1px solid #d9d9d9;
    white-space: pre-wrap;
    word-wrap: break-word;
}
pre code {
    background-color: #fff;
    color:#737373;
    font-size: 11px;
    padding: 0;
}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:10px auto;
    }
}
@media print {
	body,code,pre code,h1,h2,h3,h4,h5,h6 {
		color: black;
	}
	table, pre {
		page-break-inside: avoid;
	}
}
</style>
<title>项目说明文档</title>

</head>
<body>
<h2>项目说明文档</h2>

<h4>开发环境配置</h4>

<ul>
<li>安装<code>TexturePacker</code>及其命令行工具</li>
<li>安装<code>poedit_osx.zip</code> 和 <code>poxls-1.1.0.tar.gz</code></li>
<li>设置环境变量<code>RELEASE_GIT_AUTO_UPDATE</code> 指向自动更新仓库的本地绝对路径(仓库地址:git@github.com:ModunZhang/kod_update_server.git)</li>
<li>确保<code>tools/scripts</code>下的所有脚本均有执行权限(执行脚本14安装)</li>
<li>其他环境(iOS/Android)</li>
</ul>


<h4><span id="scripts">脚本文件说明</span></h4>

<blockquote><p>文件名加粗的脚本不关心,未加粗的才是常用脚本</p></blockquote>

<ol>
<li><p>buildGame.sh
 执行lua和资源的导出
 参数:1.平台 2.是否加密lua 3.是否加密资源(执行选择相应参数即可)</p></li>
<li><p>buildLuaConfig.sh
 把excel配置表导出为lua文件</p></li>
<li><p>buildRes.sh
 导出项目的资源
 参数:1.平台 2.是否加密</p></li>
<li><p>buildScripts.sh
 导出项目的lua文件
 参数:1.平台 2.是否加密</p></li>
<li><p>buildUpdate.sh
 发布自动更新脚本,执行选择相应参数即可</p></li>
<li><p>build_format_map.py
 构建图片信息的python实现</p></li>
<li><p>cleanGame.sh
 清除生成项目的中间文件和update目录</p></li>
<li><p>cleanMacPlayer.sh
 清除保存在player中的userdefault中的信息,不会重置openudid</p></li>
<li><p>cleanTempFile.sh
 清除生成项目的中间文件,但是不会清除update目录</p></li>
<li><p>exportPO2Xlsx.sh
将项目的本地化po文件导出为excel文件
参数:1.将要导出的excel文件的路径(xlsx后缀名)</p></li>
<li><p>exportXlsx2po.sh
将脚本10导出的excel导回项目中
参数:1.将要导入的excel文件路径(xlsx后缀名)</p></li>
<li><p>export_plist_texture_data.sh
将合成的大图信息导出到项目中(执行选择相应参数即可)</p></li>
<li><p><strong>functions.sh</strong>
为其他脚本提供基础函数的脚本，<code>如果要改变加密资源和lua的XXTEA信息就修改这个文件中的值</code></p></li>
<li><p>install.sh
为所有的脚本添加执行权限</p></li>
<li><p><strong>plist_texture_data_to_lua.py</strong>
脚本12的python实现</p></li>
<li><p>syncUpdateDataToGit.sh
将生成的update目录上传到相应的git仓库,这个脚本不会自动部署服务器，需要手动ssh到服务器pull版本号使用这个脚本前必须确认全局shell变量<code>RELEASE_GIT_AUTO_UPDATE</code></p></li>
<li><p>buildTexture.sh
导出游戏的大图到images下，分为player和iOS</p></li>
<li><p><strong>AndroidXml.py</strong>
Android读取项目配置文件脚本的pythod实现</p></li>
<li><p>create_android_zip.sh
Android下打包资源为zip</p></li>
<li><p>gcm_push.py
Android GCM推送测试脚本,用法:</p>

<pre><code>python gcm_push.py --message="Bye Bye" --id="APA91bEv6GmHN3q5Swrsu_Lxxw9zds3Q2C2TPwtWIrBDbouo4uyyE5AdaKxFnZ39FYg0dyJcliPBZa_fqrc5figMZ5-M-gMNfWb_VAm6-HQS1QiDbdyBGTnPysaMw4cBsOGaUkPUbkm_"
</code></pre></li>
</ol>


<hr />

<h4>本地化说明</h4>

<ol>
<li><p>安装<code>poxls-1.1.0.tar.gz</code>和<code>poedit_osx.zip</code></p></li>
<li><p>用poedit更新所有po文件的本地化信息</p></li>
<li><p>执行脚本<code>exportPO2Xlsx.sh</code>将po文件导出为excel</p></li>
<li><p>excel修改完成后执行脚本<code>exportXlsx2po.sh</code>将excel导出为最新的po文件</p></li>
<li><p>用poedit设置所有po文件(每个po文件都需要设置)的属性(代码编码为utf8,搜索路径为app目录,搜索关键词为下划线，poedit的首选项只需设置一次 <a href="http://zengrong.net/post/1986.htm" title="详细说明">参考文章</a></p></li>
<li><p>更新本地化文件</p></li>
</ol>


<blockquote><p>如果第6步执行不了，原因就是第5步没有设置好!</p></blockquote>

<p><strong>5-6 图解</strong></p>

<hr />

<p><img src="./res/1.png" alt="poedit-&gt;首选项" /></p>

<p><img src="./res/2.png" alt="lua项目的设置" /></p>

<p><img src="./res/3.png" alt="po文件Catalog" /></p>

<p><img src="./res/4.png" alt="代码编码为utf8" /></p>

<p><img src="./res/5.png" alt="搜索路径为app目录" /></p>

<p><img src="./res/6.png" alt="搜索路径为app目录" /></p>

<p><img src="./res/7.png" alt="搜索关键词为下划线" /></p>

<p><img src="./res/8.png" alt="搜索关键词为下划线" /></p>

<hr />

<h4>贴图说明</h4>

<h6>images下文件夹说明</h6>

<pre><code>_CanCompress:将被直接压缩为pvrtc4的散图
_Compressed:iOS已经被合成最终大图的图
_Compressed_mac:Player已经被合成最终大图的图
rgba444_single:将被压缩为rgba4444格式的散图
</code></pre>

<h6>贴图操作说明:</h6>

<ol>
<li>所有的大图项目在<code>PackImages</code>文件夹下,TextPacker的项目文件也在里面,使用用脚本<code>buildTexture.sh</code>导出</li>
<li>所有新加的图需要用<code>ImageOptim.app</code>执行一次无损压缩再放入项目中</li>
</ol>


<hr />

<h4>Xcode一般调试步骤(Debug)</h4>

<ul>
<li>修改项目 关闭Lua中的自动更新逻辑</li>
<li><code>Xcode设置DEBUG为YES.</code>(AppHoc变量)<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></li>
<li>如果只修改了Lua,执行脚本4 <code>buildScripts.sh iOS false</code></li>
<li>如果只修改了资源,执行脚本3 <code>buildRes.sh iOS false</code></li>
<li>如果都有修改执行,执行脚本1 <code>buildGame.sh iOS false false</code></li>
<li>Xcode执行</li>
</ul>


<hr />

<h4><span id="normal">自动更新说明</span></h4>

<h6>自动更新相关注意点</h6>

<pre><code>1.Xcode中Info.plist的版本号设置(`CFBundleShortVersionString`为当前版本号,`AppMinVersion`为支持的最低版本号)，DEBUG的设置(`AppHoc`)
2.config.lua文件不能被自动更新(cpp写死的)
3.大版本号和小版本由Xcode中设置的大版本号和小版本号生成json文件
4.每次发布新ipa包，大版本号必须比线上的高
5.运行自动更新脚本的时候不要再修改项目的文件!包括其他人此时也不能提交任何东西到git仓库
</code></pre>

<p>  举例:手机上此时装的<code>1.0(123)</code><sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<ul>
<li><p>我们发布自动更新<code>1.0(456)</code>,最低版本支持为<code>1.0</code><sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>,部署到更新服务器,手机直接启动游戏，会走自动更新。<a href="#ipa0">自动更新发布步骤</a></p></li>
<li><p>我们发布新包<code>1.0(456)</code>,最低版本支持为<code>1.0</code>,部署到更新服务器。<code>把1.0(456)</code>的包覆盖安装到手机上(<code>1.0(123)</code>)，启动游戏仍然版本会是<code>1.0(123)</code>,手机依然会走自动更新流程。</p></li>
<li><p>我们发布新包<code>1.0(456)</code>,最低版本支持为<code>1.0</code>,部署更新服务器。手机上删除<code>1.0(123)</code>这个包，把<code>1.0(456)</code>的包安装新手机上，启动游戏不会走自动更新流程。</p></li>
<li><p>我们发布新包<code>1.1(456)</code>,最低版本支持为<code>1.1</code>,部署到更新服务器,如果覆盖安装到手机上,启动游戏版本会是<code>1.1(456)</code>不会走自动更新。如果我们不覆盖安装，直接启动<code>1.0(123)</code>,会走强制更新流程。<a href="#ipa1">发布新版本说明</a></p></li>
<li><p>我们发布新包<code>1.1(456)</code>,最低版本支持为<code>1.0</code>,部署到更新服务器。覆盖安装到手机。不会走自动更新,这个包就是兼容包。<a href="#ipa2">兼容包发布说明</a></p></li>
</ul>


<blockquote><p>发布自动更新的时候一定检查git仓库版本号,不要轻易部署</p></blockquote>

<h6><span id="ipa0">自动更新发布步骤</span></h6>

<pre><code>自动更新生成的脚本和资源加密参数必须为true
</code></pre>

<ul>
<li>上传所有的修改文件到develop分支,更新本地develop仓库，确保本地develop分支为最新</li>
<li>检查lua代码是否调用了新的底层函数<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup></li>
<li>确保config.lua中的自动更新为打开状态</li>
<li>检查自动更新逻辑部分是否被修改(GameUILoginBeta.lua、GameUISplashBeta.lua)，自动更新可以更新自动更新的逻辑</li>
<li>检查Xcode中Info.plist的版本号设置(<code>CFBundleShortVersionString</code>为当前版本号,<code>AppMinVersion</code>为支持的最低版本号)</li>
<li>切换到master分支</li>
<li>合并develop分支到master分支,提交master并推送到远端仓库</li>
<li>在master分支上执行脚本<code>cleanGame.sh</code>清空update目录</li>
<li>在master分支上执行脚本<code>buildUpdate.sh</code>生成自动更新文件</li>
<li>成功后执行脚本<code>syncUpdateDataToGit.sh</code>上传自动更新文件到github</li>
<li>部署自动更新的服务器(测试服务器或者正式服务器)</li>
<li>如果是测试自动更新，最好测试完毕后还原master分支到线上版本的tag位置，如果没问题手动push项目master分支,把生成的自动更新文件推送到远端仓库</li>
<li>为master打tag</li>
</ul>


<hr />

<h4><span id="ipa1">发布新版本说明</span></h4>

<blockquote><p>调整Xcode中支持的最低版本号高于线上某app的版本号,Xcode设置是否是DEBUG为NO. 然后执行自动更新的所有步骤,最后使用Xcode打包ipa即可。</p></blockquote>

<hr />

<h4><span id="ipa2">兼容包发布说明</span></h4>

<ol>
<li>Xcode设置当前版本号<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup>比线上app高,最低版本号小于或者等于线上app的当前版本号</li>
<li>Xcode设置DEBUG为NO。</li>
<li>执行自动更新的所有步骤。</li>
<li>最后Xcode打包ipa即可</li>
</ol>


<hr />

<h1>Android下的特殊说明</h1>

<hr />

<ul>
<li>执行编译Lua脚本和资源脚本后,需要执行脚本19<span id="scripts">脚本文件说明</span>后打包apk.</li>
<li>Android的<code>AndroidManifest.xml</code>配置文件对应者Xcode的<code>Info.plist</code>文件,上文中描述对Xcode的设置操作都对应Android下<code>AndroidManifest.xml</code>文件的操作！</li>
</ul>


<p><strong>提供XCode和Android字段对应表</strong></p>

<table>
<thead>
<tr>
<th>Plist (Info.plist)         </th>
<th> Xml (AndroidManifest.xml)</th>
</tr>
</thead>
<tbody>
<tr>
<td>CFBundleShortVersionString </td>
<td> android:versionName</td>
</tr>
<tr>
<td>CFBundleVersion            </td>
<td> android:versionCode</td>
</tr>
<tr>
<td>AppHoc                     </td>
<td> AppHoc</td>
</tr>
<tr>
<td>AppMinVersion              </td>
<td> AppMinVersion</td>
</tr>
</tbody>
</table>


<hr />

<p>September 15, 2015 By Danny He</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><code>AppHoc</code><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>这里的1.0指的是ipa的版本<code>CFBundleShortVersionString</code><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p><code>AppMinVersion</code><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p>使用<code>git diff</code>查看<code>frameworks</code>目录(底层)是否变动<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p><code>CFBundleShortVersionString</code><a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</body>
</html>