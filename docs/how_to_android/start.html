<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
h1,
h2,
h3,
h4,
h5,
h6,
p,
blockquote {
    margin: 0;
    padding: 0;
}
body {
    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    color: #737373;
    background-color: white;
    margin: 10px 13px 10px 13px;
}
table {
	margin: 10px 0 15px 0;
	border-collapse: collapse;
}
td,th {	
	border: 1px solid #ddd;
	padding: 3px 10px;
}
th {
	padding: 5px 10px;	
}

a {
    color: #0069d6;
}
a:hover {
    color: #0050a3;
    text-decoration: none;
}
a img {
    border: none;
}
p {
    margin-bottom: 9px;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    color: #404040;
    line-height: 36px;
}
h1 {
    margin-bottom: 18px;
    font-size: 30px;
}
h2 {
    font-size: 24px;
}
h3 {
    font-size: 18px;
}
h4 {
    font-size: 16px;
}
h5 {
    font-size: 14px;
}
h6 {
    font-size: 13px;
}
hr {
    margin: 0 0 19px;
    border: 0;
    border-bottom: 1px solid #ccc;
}
blockquote {
    padding: 13px 13px 21px 15px;
    margin-bottom: 18px;
    font-family:georgia,serif;
    font-style: italic;
}
blockquote:before {
    content:"\201C";
    font-size:40px;
    margin-left:-10px;
    font-family:georgia,serif;
    color:#eee;
}
blockquote p {
    font-size: 14px;
    font-weight: 300;
    line-height: 18px;
    margin-bottom: 0;
    font-style: italic;
}
code, pre {
    font-family: Monaco, Andale Mono, Courier New, monospace;
}
code {
    background-color: #fee9cc;
    color: rgba(0, 0, 0, 0.75);
    padding: 1px 3px;
    font-size: 12px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}
pre {
    display: block;
    padding: 14px;
    margin: 0 0 18px;
    line-height: 16px;
    font-size: 11px;
    border: 1px solid #d9d9d9;
    white-space: pre-wrap;
    word-wrap: break-word;
}
pre code {
    background-color: #fff;
    color:#737373;
    font-size: 11px;
    padding: 0;
}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:10px auto;
    }
}
@media print {
	body,code,pre code,h1,h2,h3,h4,h5,h6 {
		color: black;
	}
	table, pre {
		page-break-inside: avoid;
	}
}
</style>
<title>编译 Android 工程</title>

</head>
<body>
<h1>编译 Android 工程</h1>

<hr />

<p>要编译 Android 功能，必须使用最新版本的 Android SDK 和<code>指定的 r9d 版本</code> Android NDK.</p>

<h2>安装部分</h2>

<ol>
<li><p>安装jdk1.7.找到JDK的绝对路径,如:<code>/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home</code></p></li>
<li><p>安装Android. Stand-alone SDK Tools,从 <a href="http://developer.android.com/sdk/installing/index.html">http://developer.android.com/sdk/installing/index.html</a> 下载最新版本的SDK Tools.下载解压缩,不能放在包含中文和空格的目录中.</p></li>
<li><p>安装NDK.由于 cocos2d-x 还不支持最新的 NDK r10，所以我们需要从网络上搜索 NDK r9d 下载用于编译.下载解压缩,不能放在包含中文和空格的目录中.</p></li>
<li><p>安装Ant. 从 <a href="http://ant.apache.org/">http://ant.apache.org/</a> 下载最新版本的Ant 执行文件.下载解压缩,不能放在包含中文和空格的目录中.</p></li>
<li><p>安装Eclipse Mars(Java Developer版本即可).下载解压缩,不能放在包含中文和空格的目录中.</p></li>
</ol>


<h2>配置工作</h2>

<ul>
<li><p>Mac 下修改环境变量：</p>

<p>编辑<code>~/.zshrc</code>或者<code>~/.profile</code>文件</p>

<p>添加以下代码：</p>

<pre><code>#Android Developer
export JAVA_HOME=JDK绝对路径
export ANT_HOME=ANT根目录绝对路径
export ANDROID_NDK_ROOT=NDK根目录绝对路径
export ANDROID_SDK_ROOT=SDK根目录绝对路径

#2dx console part
export NDK_ROOT=${ANDROID_NDK_ROOT}
export ANT_ROOT=${ANT_HOME}/bin
export ANDROID_HOME=${ANDROID_SDK_ROOT}   

export PATH=$PATH:${ANDROID_NDK_ROOT}:${ANT_ROOT}:${ANDROID_SDK_ROOT}:${ANDROID_SDK_ROOT}/tools:${ANDROID_SDK_ROOT}/platform-tools
</code></pre>

<p>例如：</p>

<pre><code>#Android Developer
export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home
export ANT_HOME=/Users/dannyhe/WorkSpace/Android/sdk/apache-ant-1.9.6
export ANDROID_NDK_ROOT=/Users/dannyhe/WorkSpace/Android/sdk/android-ndk-r9d
export ANDROID_SDK_ROOT=/Users/dannyhe/WorkSpace/Android/sdk/android-sdk-macosx

#2dx console part
export NDK_ROOT=${ANDROID_NDK_ROOT}
export ANT_ROOT=${ANT_HOME}/bin
export ANDROID_HOME=${ANDROID_SDK_ROOT}   

export PATH=$PATH:${ANDROID_NDK_ROOT}:${ANT_ROOT}:${ANDROID_SDK_ROOT}:${ANDROID_SDK_ROOT}/tools:${ANDROID_SDK_ROOT}/platform-tools
</code></pre></li>
<li><p>SDK配置</p>

<ol>
<li><p> 终端执行<code>android</code>命令,对 SDK 进行更新.至少要安装<code>android-10</code></p></li>
<li><p> 按照<a href="http://developer.android.com/tools/help/adt.html">http://developer.android.com/tools/help/adt.html</a>的步骤安装ADT到Eclipse.</p></li>
</ol>
</li>
<li><p>Android配置文件</p>

<p>创建文件<code>local.properties</code>,添加以下代码:</p>

<pre><code># This file is automatically generated by Android Tools.
# Do not modify this file -- YOUR CHANGES WILL BE ERASED!
#
# This file must *NOT* be checked into Version Control Systems,
# as it contains information specific to your local configuration.

# location of the SDK. This is only used by Ant
# For customization when using a Version Control System, please read the
# header note.
sdk.dir=SDK根目录绝对路径
</code></pre>

<p>例如：</p>

<pre><code># This file is automatically generated by Android Tools.
# Do not modify this file -- YOUR CHANGES WILL BE ERASED!
#
# This file must *NOT* be checked into Version Control Systems,
# as it contains information specific to your local configuration.

# location of the SDK. This is only used by Ant
# For customization when using a Version Control System, please read the
# header note.
sdk.dir=/Users/dannyhe/WorkSpace/Android/sdk/android-sdk-macosx
</code></pre>

<p>复制<code>local.properties</code>到以下路径:</p>

<ul>
<li>Dragonfall/frameworks/runtime-src/proj.android</li>
<li>Dragonfall/frameworks/cocos2d-x/cocos/platform/android/java</li>
<li>external/Android/google-play-services_lib_3225130/google-play-services_lib</li>
</ul>
</li>
</ul>


<p>如果编译失败，请仔细检查 SDK/NDK 版本、安装路径.</p>

<blockquote><p>修改了环境设置后，必须重新打开终端窗口才能生效.</p></blockquote>

<h3>将项目导入 Eclipse ADT</h3>

<p>启动后，需要先导入 cocos2d-x 的 Java 库：</p>

<ol>
<li>选择菜单 File -> Import, 再选择 Android -> Existing Android Code Into Workspace</li>
<li>点击 Browse 按钮, 选择新工程目录中的 <code>Dragonfall/frameworks/cocos2d-x/cocos/platform/android/java</code></li>
<li>点击 "Finish" 完成操作.</li>
</ol>


<p>接下来导入 Google Play 的依赖库</p>

<ol>
<li>重复上述步骤，导入 <code>external/Android/google-play-services_lib_3225130/google-play-services_lib</code></li>
</ol>


<p>接下来导入项目的Android 工程：</p>

<ol>
<li>重复导入步骤，导入 <code>Dragonfall/frameworks/runtime-src/proj.android</code></li>
<li>在 <code>Dragonfall</code> 工程上点击右键选择菜单 "Properties" 打开工程设置对话框</li>
<li><p>检查 <code>Project Build Target</code> 是否是Android-10 SDK</p>

<p><img src="res/check-project.png" alt="" /></p></li>
</ol>


<p>如果完成上述操作后，Eclipse ADT 窗口 <code>Package Explorer</code> 列出的 <code>libcocos2dx</code> 、 <code>google-play-services_lib</code> 和 <code>Dragonfall</code> 项目文件夹上有红色错误图标.请仔细检查 <code>libcocos2dx</code> 和 <code>google-play-services_lib</code> 项目的操作步骤，以及 <code>Project Build Target</code> 是否是最新版本的 SDK.</p>

<p><code>如果确认无误后依然有红色错误图标,清理一下Eclipse中的所有项目</code></p>

<h3>设置 Android 设备允许真机调试</h3>

<p>Android 官方文档：http://developer.android.com/tools/device.html</p>

<ol>
<li><p>Enable USB debugging on your device.</p>

<ul>
<li>On most devices running Android 3.2 or older, you can find the option under Settings > Applications > Development.</li>
<li><p>On Android 4.0 and newer, it’s in Settings > Developer options.</p>

<p>Note: On Android 4.2 and newer, Developer options is hidden by default. To make it available, go to Settings > About phone and tap Build number seven times. Return to the previous screen to find Developer options.</p></li>
<li><p>在系统设置中找到“开发者选项”，打开“USB调试”.Android 4.2 开始，<code>开发者选项</code>默认是隐藏的，需要打开<code>设置-&gt;关于</code>界面，然后在<code>Build Number</code>上点击七次才能打开<code>开发者选项</code>.</p></li>
</ul>
</li>
<li><p>Set up your system to detect your device.</p>

<ul>
<li><p>If you’re developing on Windows, you need to install a USB driver for adb. For an installation guide and links to OEM drivers, see the OEM USB Drivers document.</p></li>
<li><p>根据不同的机型，也许需要安装该机型特定的 USB 驱动程序.例如 Moto 就必须安装 Moto 的 USB 驱动.</p></li>
</ul>
</li>
<li><p>Connect your device.</p>

<p>完成设置后，将设备连接到开发机，并解锁设备.</p></li>
</ol>


<h3>在设备运行项目</h3>

<ol>
<li>关闭Eclipse.我们将使用Ant进行项目编译和安装.</li>
<li>连接手机，确保手机连接成功.</li>
<li><p>在终端中进入项目的脚本工具命令目录,按顺序执行以下命令</p>

<ul>
<li>如果是开发模式(debug)</li>
</ul>


<pre><code>sh buildGame.sh Android false false
sh create_android_zip.sh
</code></pre>

<ul>
<li>如果是发布模式(release)</li>
</ul>


<pre><code>sh buildGame.sh Android true true
sh create_android_zip.sh
</code></pre></li>
<li><p>在终端中进入项目的Android目录<code>Dragonfall/frameworks/runtime-src/proj.android</code>,然后执行以下命令</p>

<ul>
<li>如果是开发模式(debug)</li>
</ul>


<pre><code>sh build_native.sh
ant clean
ant debug
ant installd
ant run
</code></pre>

<ul>
<li>如果是发布模式(release)</li>
</ul>


<pre><code>sh build_native_release.sh
ant clean
ant release
ant installr
ant run
</code></pre></li>
</ol>


<h3>其他技巧</h3>

<ul>
<li>命令

<ul>
<li>如果要快速安装到设备上(先卸载再安装新包),提供了<code>ant quickd</code>和<code>ant quickr</code></li>
<li>如果只是修改了Lua脚本并要在真机上测试,编译好脚本后执行<code>ant replaceLua</code>,然后<code>ant restart</code></li>
<li>如何检查手机已经连接好了电脑:执行<code>adb devices</code>查看是否有你的设备信息</li>
<li>如何不打开Eclipse的时候查看日志:执行命令<code>monitor</code>启动Android Monitor</li>
</ul>
</li>
</ul>


<h3>使用模块化编译缩小 apk 体积</h3>

<p>从quick 3.5开始,官方不再提供模块化编译的功能，我们项目参考3.3的编译宏定义提供部分模块化编译的功能</p>

<blockquote><p>测试编译麻烦，我们就不提供具体减少的app体积数据! iOS中将使用新target的方式减少二进制文件的大小！</p></blockquote>

<p>打开项目中的 proj.android/jni/Application.mk 文件，然后将不需要的模块值改为 0。</p>

<table>
<thead>
<tr>
<th>MACRO        </th>
<th> 功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>CC_USE_CURL  </td>
<td> 使用 CURL 库提供 HTTP 网络功能。关闭后，assetsmanager等相关功能也会被去掉。quick 在 Android 下使用 Android 系统的 Java 接口提供 HTTP 网络功能，所以 CURL 关闭后仍然可以使用HttpRequest。</td>
</tr>
<tr>
<td>CC_USE_NETWORK_SOKET </td>
<td> 网络模块，如 socket 和 websocket</td>
</tr>
<tr>
<td>CC_USE_SIMULATOR </td>
<td> player文件</td>
</tr>
<tr>
<td>CC_USE_PHYSICS </td>
<td> 使用box2d物理引擎</td>
</tr>
<tr>
<td>CC_USE_SQLITE  </td>
<td> Sqlite 数据库扩展 lsqlite3</td>
</tr>
<tr>
<td>CC_USE_3D    </td>
<td> 使用 3D 模块。 包括3D 粒子</td>
</tr>
<tr>
<td>CC_USE_CCBUILDER </td>
<td> 使用 Cocos Builder 支持模块。</td>
</tr>
</tbody>
</table>


<hr />

<p>Last Modify By Danny He@ September 11, 2015</p>
</body>
</html>