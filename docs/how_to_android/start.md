
#编译 Android 工程
================

要编译 Android 功能，必须使用最新版本的 Android SDK 和`指定的 r9d 版本` Android NDK.

## 安装部分

1. 安装jdk1.7.找到JDK的绝对路径,如:`/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home`

2. 安装Android. Stand-alone SDK Tools,从 [http://developer.android.com/sdk/installing/index.html](http://developer.android.com/sdk/installing/index.html) 下载最新版本的SDK Tools.下载解压缩,不能放在包含中文和空格的目录中.

3. 安装NDK.由于 cocos2d-x 还不支持最新的 NDK r10，所以我们需要从网络上搜索 NDK r9d 下载用于编译.下载解压缩,不能放在包含中文和空格的目录中.

4. 安装Ant. 从 [http://ant.apache.org/](http://ant.apache.org/) 下载最新版本的Ant 执行文件.下载解压缩,不能放在包含中文和空格的目录中.

5. 安装Eclipse Mars(Java Developer版本即可).下载解压缩,不能放在包含中文和空格的目录中. 

## 配置工作

-   Mac 下修改环境变量：

    编辑`~/.zshrc`或者`~/.profile`文件
    
    添加以下代码：

    ~~~
    #Android Developer
    export JAVA_HOME=JDK绝对路径
    export ANT_HOME=ANT根目录绝对路径
    export ANDROID_NDK_ROOT=NDK根目录绝对路径
    export ANDROID_SDK_ROOT=SDK根目录绝对路径
    
    #2dx console part
    export NDK_ROOT=${ANDROID_NDK_ROOT}
    export ANT_ROOT=${ANT_HOME}/bin
    export ANDROID_HOME=${ANDROID_SDK_ROOT}   
    
    export PATH=$PATH:${ANDROID_NDK_ROOT}:${ANT_ROOT}:${ANDROID_SDK_ROOT}:${ANDROID_SDK_ROOT}/tools:${ANDROID_SDK_ROOT}/platform-tools
    ~~~

    例如：

    ~~~
    #Android Developer
    export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home
    export ANT_HOME=/Users/dannyhe/WorkSpace/Android/sdk/apache-ant-1.9.6
    export ANDROID_NDK_ROOT=/Users/dannyhe/WorkSpace/Android/sdk/android-ndk-r9d
    export ANDROID_SDK_ROOT=/Users/dannyhe/WorkSpace/Android/sdk/android-sdk-macosx
    
    #2dx console part
    export NDK_ROOT=${ANDROID_NDK_ROOT}
    export ANT_ROOT=${ANT_HOME}/bin
    export ANDROID_HOME=${ANDROID_SDK_ROOT}   

    export PATH=$PATH:${ANDROID_NDK_ROOT}:${ANT_ROOT}:${ANDROID_SDK_ROOT}:${ANDROID_SDK_ROOT}/tools:${ANDROID_SDK_ROOT}/platform-tools
    ~~~

- SDK配置

    1. 终端执行`android`命令,对 SDK 进行更新.至少要安装`android-10`
    
    2. 按照[http://developer.android.com/tools/help/adt.html](http://developer.android.com/tools/help/adt.html)的步骤安装ADT到Eclipse.

- Android配置文件
  
  创建文件`local.properties`,添加以下代码:
  
  ~~~
  # This file is automatically generated by Android Tools.
  # Do not modify this file -- YOUR CHANGES WILL BE ERASED!
  #
  # This file must *NOT* be checked into Version Control Systems,
  # as it contains information specific to your local configuration.

  # location of the SDK. This is only used by Ant
  # For customization when using a Version Control System, please read the
  # header note.
  sdk.dir=SDK根目录绝对路径
  ~~~
  
  例如：
  
  ~~~
  # This file is automatically generated by Android Tools.
  # Do not modify this file -- YOUR CHANGES WILL BE ERASED!
  #
  # This file must *NOT* be checked into Version Control Systems,
  # as it contains information specific to your local configuration.

  # location of the SDK. This is only used by Ant
  # For customization when using a Version Control System, please read the
  # header note.
  sdk.dir=/Users/dannyhe/WorkSpace/Android/sdk/android-sdk-macosx
  ~~~

  复制`local.properties`到以下路径:
  
  * Dragonfall/frameworks/runtime-src/proj.android
  * Dragonfall/frameworks/cocos2d-x/cocos/platform/android/java
  * external/Android/google-play-services_lib_3225130/google-play-services_lib
  

如果编译失败，请仔细检查 SDK/NDK 版本、安装路径.

> 修改了环境设置后，必须重新打开终端窗口才能生效.

### 将项目导入 Eclipse ADT

启动后，需要先导入 cocos2d-x 的 Java 库：

1.  选择菜单 File -> Import, 再选择 Android -> Existing Android Code Into Workspace
2.  点击 Browse 按钮, 选择新工程目录中的 `Dragonfall/frameworks/cocos2d-x/cocos/platform/android/java`
3.  点击 "Finish" 完成操作.

接下来导入 Google Play 的依赖库

1. 重复上述步骤，导入 `external/Android/google-play-services_lib_3225130/google-play-services_lib`

接下来导入项目的Android 工程：

1.  重复导入步骤，导入 `Dragonfall/frameworks/runtime-src/proj.android`
2.  在 `Dragonfall` 工程上点击右键选择菜单 "Properties" 打开工程设置对话框
3.  检查 `Project Build Target` 是否是Android-10 SDK

    ![](res/check-project.png)



如果完成上述操作后，Eclipse ADT 窗口 `Package Explorer` 列出的 `libcocos2dx` 、 `google-play-services_lib` 和 `Dragonfall` 项目文件夹上有红色错误图标.请仔细检查 `libcocos2dx` 和 `google-play-services_lib` 项目的操作步骤，以及 `Project Build Target` 是否是最新版本的 SDK.

`如果确认无误后依然有红色错误图标,清理一下Eclipse中的所有项目`

### 设置 Android 设备允许真机调试 ###

Android 官方文档：http://developer.android.com/tools/device.html

1.  Enable USB debugging on your device.

    -   On most devices running Android 3.2 or older, you can find the option under Settings > Applications > Development.
    -   On Android 4.0 and newer, it’s in Settings > Developer options.

        Note: On Android 4.2 and newer, Developer options is hidden by default. To make it available, go to Settings > About phone and tap Build number seven times. Return to the previous screen to find Developer options.
    
    -   在系统设置中找到“开发者选项”，打开“USB调试”.Android 4.2 开始，`开发者选项`默认是隐藏的，需要打开`设置->关于`界面，然后在`Build Number`上点击七次才能打开`开发者选项`.

2.  Set up your system to detect your device.

    -   If you’re developing on Windows, you need to install a USB driver for adb. For an installation guide and links to OEM drivers, see the OEM USB Drivers document.

    -   根据不同的机型，也许需要安装该机型特定的 USB 驱动程序.例如 Moto 就必须安装 Moto 的 USB 驱动.

3.  Connect your device.
    
    完成设置后，将设备连接到开发机，并解锁设备.



### 在设备运行项目 ###

1. 关闭Eclipse.我们将使用Ant进行项目编译和安装.
2. 连接手机，确保手机连接成功.
3. 在终端中进入项目的脚本工具命令目录,按顺序执行以下命令
   
   * 如果是开发模式(debug)
    
    
   ~~~
   sh buildGame.sh Android false false
   sh create_android_zip.sh
   ~~~
   
   * 如果是发布模式(release)
   
   
   ~~~
   sh buildGame.sh Android true true
   sh create_android_zip.sh
   ~~~
   
4. 在终端中进入项目的Android目录`Dragonfall/frameworks/runtime-src/proj.android`,然后执行以下命令

    * 如果是开发模式(debug)

   ~~~
   sh build_native.sh
   ant clean
   ant debug
   ant installd
   ant run
   ~~~
   
   * 如果是发布模式(release)
   
   ~~~
   sh build_native_release.sh
   ant clean
   ant release
   ant installr
   ant run
   ~~~

### 其他技巧 ###

* 命令
  * 如果要快速安装到设备上(先卸载再安装新包),提供了`ant quickd`和`ant quickr`
  * 如果只是修改了Lua脚本并要在真机上测试,编译好脚本后执行`ant replaceLua`,然后`ant restart`
  * 如何检查手机已经连接好了电脑:执行`adb devices`查看是否有你的设备信息
  * 如何不打开Eclipse的时候查看日志:执行命令`monitor`启动Android Monitor
  
### 使用模块化编译缩小 apk 体积 ###

从quick 3.5开始,官方不再提供模块化编译的功能，我们项目参考3.3的编译宏定义提供部分模块化编译的功能

> 测试编译麻烦，我们就不提供具体减少的app体积数据! iOS中将使用新target的方式减少二进制文件的大小！

打开项目中的 proj.android/jni/Application.mk 文件，然后将不需要的模块值改为 0。

MACRO        | 功能 
------------ | ------------- 
CC_USE_CURL  | 使用 CURL 库提供 HTTP 网络功能。关闭后，assetsmanager等相关功能也会被去掉。quick 在 Android 下使用 Android 系统的 Java 接口提供 HTTP 网络功能，所以 CURL 关闭后仍然可以使用HttpRequest。
CC_USE_NETWORK_SOKET | 网络模块，如 socket 和 websocket 
CC_USE_SIMULATOR | player文件
CC_USE_PHYSICS | 使用box2d物理引擎
CC_USE_SQLITE  | Sqlite 数据库扩展 lsqlite3
CC_USE_3D    | 使用 3D 模块。 包括3D 粒子
CC_USE_CCBUILDER | 使用 Cocos Builder 支持模块。

---

Last Modify By Danny He@ September 11, 2015
   